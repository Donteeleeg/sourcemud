# CONFIG
CXXFLAGS = -I. -Iinclude @CXXFLAGS@
LIBS = @LIBS@

VERSION = @PACKAGE_VERSION@
PACKAGE = @PACKAGE_TARNAME@-$(VERSION)
PERL = @PATH_PERL@
XSLTPROC = @PATH_XSLTPROC@

BUILDDIR = .build
DEPDIR = .deps

# FILES
HEADERS = \
	include/common/base64.h \
	include/common/bitset.h \
	include/common/error.h \
	include/common/fdprintf.h \
	include/common/file.h \
	include/common/imanager.h \
	include/common/log.h \
	include/common/mail.h \
	include/common/md5.h \
	include/common/rand.h \
	include/common/regex.h \
	include/common/streams.h \
	include/common/streamtime.h \
	include/common/strbuf.h \
	include/common/string.h \
	include/common/time.h \
	include/common/types.h \
	include/generated/events.h \
	include/lua/core.h \
	include/lua/exec.h \
	include/lua/print.h \
	include/mud/account.h \
	include/mud/action.h \
	include/mud/body.h \
	include/mud/caffect.h \
	include/mud/clock.h \
	include/mud/color.h \
	include/mud/command.h \
	include/mud/creation.h \
	include/mud/creature.h \
	include/mud/efactory.h \
	include/mud/elist.h \
	include/mud/entity.h \
	include/mud/event.h \
	include/mud/fileobj.h \
	include/mud/filetab.h \
	include/mud/form.h \
	include/mud/gametime.h \
	include/mud/help.h \
	include/mud/hooks.h \
	include/mud/idmap.h \
	include/mud/login.h \
	include/mud/macro.h \
	include/mud/message.h \
	include/mud/name.h \
	include/mud/npc.h \
	include/mud/object.h \
	include/mud/unique-object.h \
	include/mud/shadow-object.h \
	include/mud/olc.h \
	include/mud/pconn.h \
	include/mud/player.h \
	include/mud/portal.h \
	include/mud/race.h \
	include/mud/room.h \
	include/mud/server.h \
	include/mud/settings.h \
	include/mud/skill.h \
	include/mud/tag.h \
	include/mud/timer.h \
	include/mud/uniqid.h \
	include/mud/weather.h \
	include/mud/zone.h \
	include/net/http.h \
	include/net/iplist.h \
	include/net/manager.h \
	include/net/socket.h \
	include/net/telnet.h \
	include/net/util.h \
	include/net/zmp.h

SOURCES = \
	src/common/base64.cc \
	src/common/error.cc \
	src/common/fdprintf.cc \
	src/common/file.cc \
	src/common/imanager.cc \
	src/common/log.cc \
	src/common/md5.cc \
	src/common/rand.cc \
	src/common/regex.cc \
	src/common/streams.cc \
	src/common/strbuf.cc \
	src/common/strings.cc \
	src/common/time.cc \
	src/generated/commands.cc \
	src/generated/events.cc \
	src/lua/core.cc \
	src/lua/exec.cc \
	src/lua/mudlib.cc \
	src/lua/print.cc \
	src/mud/account.cc \
	src/mud/action.cc \
	src/mud/body.cc \
	src/mud/caffect.cc \
	src/mud/calendar.cc \
	src/mud/char_do.cc \
	src/mud/combat.cc \
	src/mud/command.cc \
	src/mud/creation.cc \
	src/mud/creature.cc \
	src/mud/efactory.cc \
	src/mud/entity.cc \
	src/mud/event.cc \
	src/mud/fileobj.cc \
	src/mud/filetab.cc \
	src/mud/form.cc \
	src/mud/help.cc \
	src/mud/hooks.cc \
	src/mud/idmap.cc \
	src/mud/login.cc \
	src/mud/macro.cc \
	src/mud/mail.cc \
	src/mud/main.cc \
	src/mud/menu.cc \
	src/mud/message.cc \
	src/mud/name.cc \
	src/mud/npc.cc \
	src/mud/object.cc \
	src/mud/olc.cc \
	src/mud/player.cc \
	src/mud/pmanager.cc \
	src/mud/portal.cc \
	src/mud/race.cc \
	src/mud/room.cc \
	src/mud/settings.cc \
	src/mud/skill.cc \
	src/mud/time.cc \
	src/mud/uniqid.cc \
	src/mud/weather.cc \
	src/mud/zone.cc \
	src/net/http.cc \
	src/net/iplist.cc \
	src/net/manager.cc \
	src/net/socket.cc \
	src/net/telnet.cc \
	src/net/util.cc \
	src/net/zmp.cc \
	$(wildcard src/cmd/*.cc)

XML = \
	src/xml/bindings.xml \
	src/xml/events.xml

TOOLS = \
	tools/parse-commands.pl \
	tools/replace.sh.in \
	tools/events-code.xsl \
	tools/events-doc.xsl \
	tools/events-header.xsl \
	tools/script-code.xsl \
	tools/script-doc.xsl \
	tools/script-header.xsl

LUA = \
	scripts/init.lua

DATA = \
	data/admin.acct \
	data/admin.ply \
	data/zones/saladhin.zone \
	data/zones/.zone \
	data/zones/underworld.zone \
	data/zones/catacombs.zone \
	data/zones/darkwood.zone \
	data/zones/example.zone.old \
	data/time \
	data/badnames \
	data/calendar \
	data/messages \
	data/races \
	data/blueprints/armor.objs \
	data/blueprints/gems.objs \
	data/blueprints/misc.objs \
	data/blueprints/weapons.objs \
	data/blueprints/animals.npcs \
	data/blueprints/undead.npcs \
	data/skills \
	data/traits \
	data/uniqid \
	data/weather \
	data/html/tpl/header.tpl \
	data/html/tpl/footer.tpl \
	data/html/tpl/index.tpl \
	data/html/account.tpl \
	data/html/stats.tpl \
	data/html/stats.html \
	data/help/commands.help \
	data/help/olc.help \
	data/help/sourcemud.help

BINARIES = sourcemud-bin
BUILD = Makefile configure
DIST = configure configure.ac Makefile.in sourcemud.in include/config.h.in
HTTPKEY = data/session.key

OBJECTS = $(SOURCES:%.cc=$(BUILDDIR)/%.o)

# CORE BUILD
all: $(BUILD) $(TOOLS) $(XML) $(HEADERS) $(SOURCES) $(OBJECTS) $(BINARIES) \
	$(HTTPKEY) $(SCRIPTS) $(DATA)

clean:
	@echo Cleaning
	@rm -fr $(BINARIES) $(OBJECTS) $(DEPDIR) $(BUILDDIR)

$(BUILDDIR)/%.o: %.cc
	@echo Compiling $<
	@[ -d $(dir $@) ] || mkdir -p $(dir $@)
	@$(CXX) -c -o $@ $(CXXFLAGS) $<
	@[ -d $(DEPDIR) ] || mkdir $(DEPDIR)
	@depfile=$(DEPDIR)/$(shell echo "$@" | \
			sed -e 's/\//_/g' -e 's/^\.build_//' -e 's/[.]o$$/.P/'); \
		$(CXX) -MM -MT $@ -o "$$depfile" $(CXXFLAGS) $<; \
		cp -f "$$depfile" "$$depfile.tmp"; \
		sed -e 's/#.*//' -e 's/^[^:]*://' -e 's/^ *//' -e 's/ *\\$$//' \
			-e '/^$$/ d' -e 's/$$/ :/' \
			< "$$depfile.tmp" >> "$$depfile"; \
		rm -f "$$depfile.tmp"

# DEPENDENCIES
-include $(DEPDIR)/*.P

# BINARIES
sourcemud-bin: $(OBJECTS)
	@echo Linking $@
	@$(CXX) -o $@ $^ $(LFLAGS) $(LIBS)

# DATE FILES
data/session.key:
	@echo Generating HTTP session key
	@head -c 512 /dev/urandom | base64 -w0 > $@

# GENERATED SOURCE
src/generated/commands.cc: tools/parse-commands.pl $(wildcard src/cmd/*.cc)
	@echo Generating $@
	@$(PERL) tools/parse-commands.pl

include/generated/bindings.h: tools/script-header.xsl src/xml/bindings.xml
	@echo Generating $@
	@-mkdir -p include/generated
	@$(XSLTPROC) tools/script-header.xsl src/xml/bindings.xml > $@ 

src/generated/bindings.cc: tools/script-code.xsl src/xml/bindings.xml
	@echo Generating $@
	@-mkdir -p include/generated
	@$(XSLTPROC) tools/script-code.xsl src/xml/bindings.xml > $@ 

include/generated/events.h: tools/events-header.xsl src/xml/events.xml
	@echo Generating $@
	@-mkdir -p include/generated
	@$(XSLTPROC) tools/events-header.xsl src/xml/events.xml > $@ 

src/generated/events.cc: tools/events-code.xsl src/xml/events.xml
	@echo Generating $@
	@-mkdir -p include/generated
	@$(XSLTPROC) tools/events-code.xsl src/xml/events.xml > $@ 

# BUILD FILES
Makefile: Makefile.in configure
	@echo Recreating Makefile
	@./config.status

configure: configure.ac
	@echo Recreating ./configure
	@autoconf && ./config.status --recheck

# DISTRIBUTION
dist: all make-dist
make-dist: configure $(DIST) $(TOOLS) $(XML) $(HEADERS) $(SOURCES) $(LUA) $(DATA)
	@echo Building distribution tarball $(PACKAGE).tar.gz
	@[ ! -d $(PACKAGE) ] || rm -fr $(PACKAGE)
	@mkdir $(PACKAGE)
	@for file in $^ ; do install -D $$file $(PACKAGE)/$$file; done
	@tar -zcf $(PACKAGE).tar.gz $(PACKAGE)
	@rm -fr $(PACKAGE)
